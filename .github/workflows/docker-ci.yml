name: Docker Build and Test

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  docker-build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        run: mvn -B clean package -DskipTests --file pom.xml

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Docker network
        run: docker network create rag-network || true

      - name: Start Elasticsearch 9.1.4
        run: |
          docker run -d \
            --name my-es \
            --network rag-network \
            -p 9200:9200 \
            -e "discovery.type=single-node" \
            -e "xpack.security.enabled=false" \
            -e "xpack.security.http.ssl.enabled=false" \
            -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
            docker.elastic.co/elasticsearch/elasticsearch:9.1.4
          
          echo "等待 Elasticsearch 启动..."
          for i in {1..30}; do
            if curl -s http://localhost:9200 >/dev/null 2>&1; then
              echo "Elasticsearch 已就绪!"
              break
            fi
            echo "等待 Elasticsearch... ($i/30)"
            sleep 3
          done

      - name: Install IK Analyzer Plugin for ES 9.1.4
        run: |
          echo "安装 IK 分词器插件 (9.1.4 版本)..."
          docker exec my-es bin/elasticsearch-plugin install --batch https://get.infini.cloud/elasticsearch/analysis-ik/9.1.4
          
          echo "重启 Elasticsearch 使插件生效..."
          docker restart my-es
          
          echo "等待 Elasticsearch 重启..."
          sleep 20
          
          echo "已安装的插件:"
          docker exec my-es bin/elasticsearch-plugin list

      - name: Create Index Mapping
        run: |
          echo "等待 Elasticsearch 完全就绪..."
          for i in {1..30}; do
            if curl -s http://localhost:9200 >/dev/null 2>&1; then
              echo "Elasticsearch 已就绪，准备创建索引映射"
              break
            fi
            echo "等待 Elasticsearch... ($i/30)"
            sleep 3
          done
          
          if [ -f "init-es-index.sh" ]; then
            echo "执行 init-es-index.sh 脚本创建索引映射..."
            chmod +x init-es-index.sh
            ./init-es-index.sh
          else
            echo "警告: init-es-index.sh 脚本不存在，尝试直接创建索引"
          fi
          
          echo "已创建的索引:"
          curl -s "http://localhost:9200/_cat/indices?v"

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: xx-rag:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image with Elasticsearch
        run: |
          docker run -d \
            --name app-test \
            --network rag-network \
            -p 8081:8081 \
            -e SPRING_ELASTICSEARCH_URIS=http://my-es:9200 \
            -e SPRING_PROFILES_ACTIVE=ci \
            xx-rag:latest
          
          echo "等待应用启动..."
          for i in {1..30}; do
            if curl -s http://localhost:8081/actuator/health >/dev/null 2>&1; then
              echo "✅ 应用已就绪!"
              break
            fi
            echo "等待应用启动... ($i/30)"
            sleep 3
          done
          
          echo "应用日志:"
          docker logs app-test --tail 50

      - name: Verify application is running
        run: |
          if [ "$(docker inspect -f '{{.State.Running}}' app-test)" = "true" ]; then
            echo "✅ 应用容器运行正常"
            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/actuator/health)
            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "✅ 健康检查通过 (HTTP $HEALTH_CHECK)"
            else
              echo "⚠️ 健康检查返回 HTTP $HEALTH_CHECK"
              curl -s http://localhost:8081/actuator/health
            fi
          else
            echo "❌ 应用容器已停止，查看日志："
            docker logs app-test
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker stop app-test my-es || true
          docker rm app-test my-es || true
          docker network rm rag-network || true